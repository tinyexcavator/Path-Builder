<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Roller Glow — Diagnostics Build</title>
<style>
  html,body{height:100%;margin:0;background:#0b0f14;color:#e8f0ff;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  #ui{position:fixed;left:12px;right:12px;bottom:12px;display:flex;gap:8px;justify-content:space-between;align-items:center;pointer-events:none}
  .card{pointer-events:auto;background:rgba(16,22,30,.7);backdrop-filter:blur(6px);border:1px solid #203040;border-radius:12px;padding:8px 10px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
  .btn{cursor:pointer;border:1px solid #2f445c;border-radius:10px;background:linear-gradient(180deg,#1a2430,#121923);color:#eaf4ff;font-weight:700;padding:8px 12px}
  .hint{opacity:.8;font-size:12px}
  canvas{display:block}
  #diag{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;text-align:center;background:rgba(10,14,20,.86);backdrop-filter:blur(6px);z-index:10}
  #diag .panel{max-width:860px;border:1px solid #5a2b36;background:#1a0f14;border-radius:14px;padding:18px;box-shadow:0 10px 30px #000a}
  #diag h1{margin:0 0 6px 0;font-size:20px}
  #diag p{margin:8px 0;color:#ffdbe6}
  #diag code{background:#0e141e;padding:2px 6px;border-radius:6px;border:1px solid #22354a}
</style>
</head>
<body>
<div id="ui" class="card">
  <div>
    <button id="prevBtn" class="btn">Prev</button>
    <span>LEVEL <span id="levelName">1</span> / 5</span>
    <button id="nextBtn" class="btn">Next</button>
    <button id="resetBtn" class="btn">Reset</button>
  </div>
  <div class="card hint">Mouse drag = rotate • Wheel = zoom • Arrows = move • Space = up • Shift = down</div>
</div>

<div id="diag">
  <div class="panel">
    <h1 id="diagTitle">Diagnostics</h1>
    <p id="diagMsg">…</p>
    <p class="hint" id="diagHint"></p>
  </div>
</div>

<script type="module">
(async ()=>{
  const diag = (title, msg, hint='')=>{
    const d=document.getElementById('diag'); d.style.display='flex';
    document.getElementById('diagTitle').textContent=title;
    document.getElementById('diagMsg').innerHTML=msg;
    document.getElementById('diagHint').innerHTML=hint;
    console.error('[Diag]', title, msg, hint);
  };

  // 1) Try to import Three + OrbitControls (with CDN fallback)
  let THREE, OrbitControls;
  try{
    THREE = await import('https://unpkg.com/three@0.160.0/build/three.module.js');
    ({ OrbitControls } = await import('https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js'));
  }catch(e1){
    try{
      THREE = await import('https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js');
      ({ OrbitControls } = await import('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js'));
    }catch(e2){
      diag('Module import failed',
        'Could not load <code>three.module.js</code> and/or <code>OrbitControls.js</code> from CDNs.',
        'If you\'re on a restricted network, try another network or browser. You can also self-host Three: <code>npm i three</code> and serve from your repo.');
      return;
    }
  }

  // 2) WebGL capability check (before creating a renderer)
  const gl2 = document.createElement('canvas').getContext('webgl2');
  const gl1 = gl2 || document.createElement('canvas').getContext('webgl');
  if(!gl1){
    diag('WebGL not available',
      'Your browser reported no WebGL context.',
      'In Safari, open <b>Develop → Show Web Inspector</b>, then reload and check the Console. Try a normal (non-private) window. Update Safari/macOS if possible. Also try Chrome or Firefox to confirm it\'s a browser setting.');
    return;
  }

  // 3) Build the scene (same as before, trimmed a bit)
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0f14);

  const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
  camera.position.set(22,18,26);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(devicePixelRatio);
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;
  document.body.appendChild(renderer.domElement);

  const controls = new OrbitControls.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.08;
  controls.minDistance = 8;
  controls.maxDistance = 80;

  scene.add(new THREE.AmbientLight(0x99aabb,0.7));
  const key = new THREE.DirectionalLight(0xffffff,0.9);
  key.position.set(10,20,10); key.castShadow=true; scene.add(key);
  const rim = new THREE.DirectionalLight(0x66aaff,0.35); rim.position.set(-12,12,-8); scene.add(rim);

  const ARENA = { x:24, y:14, z:36 };

  const levelGroup = new THREE.Group(); scene.add(levelGroup);
  const floor = new THREE.Mesh(new THREE.BoxGeometry(ARENA.x*2,1,ARENA.z*2),
                               new THREE.MeshPhongMaterial({color:0x14202e,shininess:8}));
  floor.position.y=-0.5; floor.receiveShadow=true; scene.add(floor);

  const glassMat = new THREE.MeshPhysicalMaterial({
    color:0x84a9ff, metalness:.2, roughness:.15, transmission:.6, transparent:true, opacity:.35, thickness:.6, ior:1.25
  });
  const addWall=(w,h,d,x,y,z)=>{ const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),glassMat); m.position.set(x,y,z); m.castShadow=m.receiveShadow=true; levelGroup.add(m); return m; };

  // Always-visible test cube
  const testCube = new THREE.Mesh(new THREE.BoxGeometry(3,3,3),
                    new THREE.MeshStandardMaterial({color:0xff6699,metalness:.8,roughness:.2}));
  testCube.position.set(0,3,0); scene.add(testCube);

  // Ball
  const ballRadius=1.2;
  const ball = new THREE.Mesh(new THREE.SphereGeometry(ballRadius,48,32),
              new THREE.MeshPhysicalMaterial({color:0x45a3ff,metalness:1,roughness:.15,clearcoat:1,clearcoatRoughness:.06}));
  ball.position.set(0,ballRadius,-ARENA.z+4); ball.castShadow=true; scene.add(ball);
  ball.add(new THREE.PointLight(0x46c0ff,.9,12));
  controls.target.copy(ball.position);

  // Input
  const keys = new Set();
  addEventListener('keydown', e=>{
    if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown',' ','Shift'].includes(e.key)) e.preventDefault();
    keys.add(e.key);
  });
  addEventListener('keyup', e=> keys.delete(e.key));

  // Physics
  let vel = new THREE.Vector3();
  const accel=22, drag=0.88, maxSpeed=12, bounce=0.55;
  let squash=0;

  // Levels
  const baseWalls=()=>{
    addWall(ARENA.x*2,10,0.8,0,4.5,-ARENA.z+0.4);
    addWall(ARENA.x*2,10,0.8,0,4.5, ARENA.z-0.4*
